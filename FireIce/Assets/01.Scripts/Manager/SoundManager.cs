using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Audio;

public enum SoundType
{
    BGM,
    SFX
}

public class SoundManager : Singleton<SoundManager>
{
    [SerializeField] private AudioMixer audioMixer;
    //오디오 믹서로 볼륨 조절

    [SerializeField] private List<AudioClip> audioClipList;
    //사용할 오디오 클립 보관

    [SerializeField] private int initialPoolSize = 6;
    private List<SoundPlayer> sfxPool = new List<SoundPlayer>();

    [HideInInspector]public Dictionary<SoundType, List<SoundPlayer>> soundPlayerDic;
    //재생 중인 SoundPlayer을 보관

    private string currentBGM = ""; //현재 BGM 저장

    public AudioMixer AudioMixer { get { return audioMixer; } }
    //외부에서 오디오 믹서 접근 허용

    protected override void Awake()
    {
        base.Awake();
        soundPlayerDic = new Dictionary<SoundType, List<SoundPlayer>>();
        //딕셔너리 초기화

        for(int i = 0; i < initialPoolSize; i++) //SFX사운드 재생하기 위한 객체를 미리 만들기
        {
            SoundPlayer sp = CreateSoundPlayer();
            sfxPool.Add(sp);
        }
    }

    private SoundPlayer CreateSoundPlayer() //SoundPlayer 만들기
    {
        GameObject go = new GameObject("SoundPlayer");
        go.transform.parent = this.transform;
        SoundPlayer sp = go.AddComponent<SoundPlayer>();
        return sp;
    }

    public void SetVolume(SoundType type, float volume) //볼륨 조절
    {
        audioMixer.SetFloat(type.ToString(), Mathf.Log10(volume) * 20);
    }

    public void PlaySound(SoundType type, string name, bool isLoop = false) //사운드 재생
    {
        if(type==SoundType.BGM && soundPlayerDic.ContainsKey(type) && soundPlayerDic[type].Count >= 1)
        {
            return; //BGM 단일 재생
        }
        SoundPlayer sp = GetSoundPlayerFromPool();
        AudioMixerGroup mixerGroup = audioMixer.FindMatchingGroups(type.ToString())[0];
        //AduioMixer에서 타입과 맞는 믹서그룹 찾음
        AudioClip clip = audioClipList.Find( x => x.name == name );
        //name으로 오디오 검색

        sp.Setting(mixerGroup, clip, isLoop, type);
        sp.Play();

        if (soundPlayerDic.ContainsKey(type))
        {
            soundPlayerDic[type].Add(sp);
        }
        else
        {
            soundPlayerDic.Add(type, new List<SoundPlayer> { sp });
        }
    }

    public void ChangeBGM(string newBGM)
    {
        if (currentBGM == newBGM)
        {
            return;
        }

        stopBGM();
        PlaySound(SoundType.BGM, newBGM, true);
        currentBGM = newBGM;
    }

    public void stopBGM()
    {
        if (soundPlayerDic.ContainsKey(SoundType.BGM) && soundPlayerDic[SoundType.BGM].Count > 0)
        {
            foreach (var sp in soundPlayerDic[SoundType.BGM])
            {
                sp.AudioSource.Stop();
            }
            soundPlayerDic[SoundType.BGM].Clear();
        }  
    }

    private SoundPlayer GetSoundPlayerFromPool()
    {
        foreach (var sp in sfxPool)
        {
            if (!sp.IsPlaying)
            {
                return sp;
            }
        }

        SoundPlayer newSp = CreateSoundPlayer();
        sfxPool.Add(newSp);
        return newSp;
    }
}

/*
< 씬 별 사운드 >
1. 메인화면
1-1. 도전 과제 화면
2. 스테이지 선택 화면
2-1. 커스텀 화면
3. 스테이지 1
3-1. 스테이지 2
3-2. 스테이지 3

< 사운드가 필요한 때 >
1. 캐릭터 점프
2. 캐릭터 죽음 = 게임 오버
3. 오브젝트와 상호작용 (레버나 스위치)
4. 문 열림
5. 게임 클리어
*/
